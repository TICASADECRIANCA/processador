<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Integrador Pro - CardÃ¡pio Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 850px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #27ae60; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .btn { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }
        #log { margin-top: 20px; background: #1e272e; color: #d2dae2; padding: 15px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .ok { color: #55efc4; } .err { color: #ff7675; }
    </style>
</head>
<body>
<div class="card">
    <h2>ðŸš€ Importador de Pedidos (Dupla AutenticaÃ§Ã£o)</h2>
    <input type="file" id="csvFile" accept=".csv" style="margin-bottom: 20px; width: 100%;">
    <button class="btn" onclick="iniciar()">Iniciar ImportaÃ§Ã£o</button>
    <div id="log">Aguardando arquivo...</div>
</div>

<script>
    const API_KEY = "p4ePLADE4HmFnyySyvgLAwvQUgxJPSSqZoLbpveH";
    const PARTNER_KEY = "6a9ded89-ecaf-40fd-a844-56aa00c4c1ec";
    const logDiv = document.getElementById('log');

    function writeLog(msg, type = '') {
        logDiv.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function iniciar() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Selecione o CSV!");
        logDiv.innerHTML = "";
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                writeLog(`Encontrados ${results.data.length} pedidos.`);
                for (let i = 0; i < results.data.length; i++) {
                    await enviarPedido(results.data[i], i + 1);
                }
            }
        });
    }

    async function enviarPedido(row, index) {
        const totalPedido = parseFloat(row.total) || 0;
        
        // Gerando um ID Ãºnico para cada pedido (ObrigatÃ³rio pela nova DOC)
        const orderUniqueId = "IMP_" + Date.now() + "_" + index;

        const payload = {
            "order_id": orderUniqueId,
            "display_id": (100 + index).toString(),
            "order_type": "takeout", // Usei takeout para evitar erro de endereÃ§o obrigatÃ³rio no delivery
            "customer": {
                "name": row.cliente_nome || "Cliente Importado",
                "phone": (row.cliente_telefone || "11999999999").replace(/\D/g, '').substring(0, 11)
            },
            "totals": {
                "order_amount": totalPedido,
                "delivery_fee": 0,
                "additional_fee": 0,
                "discounts": 0
            },
            "items": [{
                "name": row.produto_nome || "Produto",
                "quantity": parseInt(row.quantidade) || 1,
                "unit_price": totalPedido,
                "total_price": totalPedido
            }],
            "payments": [{
                "total": totalPedido,
                "payment_method_id": 103 // 103 costuma ser PIX, ajuste conforme o GET payment_methods
            }]
        };

        try {
            const res = await fetch("https://integracao.cardapioweb.com/api/partner/v1/orders", {
                method: 'POST',
                headers: {
                    'X-API-KEY': API_KEY,
                    'X-PARTNER-KEY': PARTNER_KEY,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (res.status === 201) {
                writeLog(`âœ… Criado: ${row.cliente_nome} (ID: ${data.id})`, 'ok');
                // Confirmar o pedido
                await fetch(`https://integracao.cardapioweb.com/api/partner/v1/orders/${data.id}/status`, {
                    method: 'PATCH',
                    headers: { 'X-API-KEY': API_KEY, 'X-PARTNER-KEY': PARTNER_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: "confirmed" })
                });
            } else {
                writeLog(`âŒ Erro: ${JSON.stringify(data.errors || data.message)}`, 'err');
            }
        } catch (e) {
            writeLog(`ðŸ’¥ Falha: ${e.message}`, 'err');
        }
    }
</script>
</body>
</html>
