<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Integrador Card√°pio Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .btn-import { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
        #log { margin-top: 20px; background: #263238; color: #cfd8dc; padding: 15px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; }
        .success { color: #81c784; }
        .error { color: #ff8a65; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Importador de Pedidos - Produ√ß√£o</h2>
    <input type="file" id="csvFile" accept=".csv" style="margin: 20px 0;">
    <button class="btn-import" onclick="processar()">üöÄ Importar e Faturar</button>
    <div id="log">Aguardando in√≠cio...</div>
</div>

<script>
    const logElement = document.getElementById('log');
    const TOKEN = "p4ePLADE4HmFnyySyvgLAwvQUgxJPSSqZoLbpveH";

    function addLog(msg, type = '') {
        logElement.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    async function processar() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Selecione o CSV!");

        logElement.innerHTML = "<b>Iniciando Processamento...</b><br>";

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                addLog(`Encontrados ${results.data.length} pedidos.`);
                for (const linha of results.data) {
                    await enviarParaAPI(linha);
                }
            }
        });
    }

    async function enviarParaAPI(row) {
        const URL = "https://integracao.cardapioweb.com/v1/pedidos";
        
        const payload = {
            order_type: row.tipo || "delivery",
            order_timing: "immediate",
            customer: { name: row.cliente_nome, phone: row.cliente_telefone },
            items: [{
                name: row.produto_nome,
                quantity: parseFloat(row.quantidade) || 1,
                unit_price: parseFloat(row.preco) || 0,
                total_price: parseFloat(row.total) || 0,
                kind: "regular_item"
            }],
            payments: [{
                total: parseFloat(row.total) || 0,
                payment_method: row.metodo_pagamento || "pix",
                payment_type: "offline",
                status: "pending"
            }],
            total: parseFloat(row.total) || 0
        };

        try {
            const res = await fetch(URL, {
                method: 'POST',
                headers: {
                    'X-API-KEY': TOKEN,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const data = await res.json();
                addLog(`‚úÖ Criado: ${row.cliente_nome} (ID: ${data.id})`, 'success');
                await faturar(data.id);
            } else {
                const erro = await res.text();
                addLog(`‚ùå Erro API: ${erro}`, 'error');
            }
        } catch (e) {
            addLog(`üí• Erro de Rede: ${e.message}`, 'error');
        }
    }

    async function faturar(id) {
        await fetch(`https://integracao.cardapioweb.com/pedidos/${id}/status`, {
            method: 'PATCH',
            headers: { 'X-API-KEY': TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'confirmed' })
        });
        addLog(`   ‚Ü≥ üí∞ Faturado!`, 'success');
    }
</script>
</body>
</html>

