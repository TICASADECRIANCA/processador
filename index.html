<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Integrador Card√°pio Web - Oficial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #log { background: #1e272e; color: #d2dae2; padding: 20px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 13px; margin-top: 20px;}
        .success { color: #55efc4; }
        .error { color: #ff7675; }
        button { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Importador de Pedidos Oficial</h2>
    <p>Status: <b>Produ√ß√£o</b></p>
    <input type="file" id="csvInput" accept=".csv" style="margin: 20px 0;"><br>
    <button onclick="processarEnvio()">üöÄ Iniciar Importa√ß√£o</button>
    <div id="log">Aguardando arquivo...</div>
</div>

<script>
    // URL DE PRODU√á√ÉO CORRIGIDA CONFORME A DOCUMENTA√á√ÉO
    const BASE_URL = "https://integracao.cardapioweb.com/api/partner/v1/orders";
    const API_KEY = "p4ePLADE4HmFnyySyvgLAwvQUgxJPSSqZoLbpveH";
    const logElement = document.getElementById('log');

    function addLog(msg, type = '') {
        logElement.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    async function processarEnvio() {
        const file = document.getElementById('csvInput').files[0];
        if (!file) return alert("Selecione o CSV!");
        logElement.innerHTML = "Iniciando...<br>";

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                addLog(`Encontrados ${results.data.length} pedidos.`);
                for (const row of results.data) {
                    await enviarPedido(row);
                }
            }
        });
    }

    async function enviarPedido(row) {
        const payload = {
            order_type: row.tipo || "delivery",
            order_timing: "immediate",
            customer: { name: row.cliente_nome, phone: row.cliente_telefone },
            items: [{
                name: row.produto_nome,
                quantity: parseFloat(row.quantidade) || 1,
                unit_price: parseFloat(row.preco) || 0,
                total_price: parseFloat(row.total) || 0,
                kind: "regular_item"
            }],
            payments: [{
                total: parseFloat(row.total) || 0,
                payment_method: row.metodo_pagamento || "pix",
                payment_type: "offline",
                status: "pending"
            }],
            total: parseFloat(row.total) || 0
        };

        try {
            const response = await fetch(BASE_URL, {
                method: 'POST',
                headers: {
                    'X-API-KEY': API_KEY,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const resJson = await response.json();
                addLog(`‚úÖ Pedido Criado: ${row.cliente_nome} (ID: ${resJson.id})`, 'success');
                
                // Confirmar o pedido (PATCH conforme a l√≥gica de status da doc)
                await fetch(`${BASE_URL}/${resJson.id}/status`, {
                    method: 'PATCH',
                    headers: { 'X-API-KEY': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: "confirmed" })
                });
                addLog(`   ‚Ü≥ üí∞ Status alterado para CONFIRMADO`, 'success');
            } else {
                const errText = await response.text();
                addLog(`‚ùå Erro em ${row.cliente_nome}: ${errText}`, 'error');
            }
        } catch (e) {
            addLog(`üí• Erro Cr√≠tico: ${e.message}`, 'error');
        }
    }
</script>
</body>
</html>
