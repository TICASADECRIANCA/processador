<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Integrador CDC - CardÃ¡pio Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #2d3436; }
        .card { max-width: 850px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #27ae60; margin-top: 0; }
        .btn { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px 0; width: 100%; transition: 0.3s; }
        .btn:hover { background: #219150; }
        .btn-diag { background: #2980b9; }
        .btn-diag:hover { background: #2471a3; }
        #log { margin-top: 20px; background: #1e272e; color: #d2dae2; padding: 15px; border-radius: 8px; height: 450px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; }
        .ok { color: #55efc4; font-weight: bold; }
        .err { color: #ff7675; }
        .info { color: #f1c40f; }
        .step { color: #3498db; border-left: 2px solid #3498db; padding-left: 10px; margin: 5px 0; }
    </style>
</head>
<body>

<div class="card">
    <h2>ðŸš€ Importador CDC </h2>
    <p>Status: <b>Pronto para ProduÃ§Ã£o (Bypass CORS)</b></p>
    
    <button class="btn btn-diag" onclick="consultarPagamentos()">1. Sincronizar Meios de Pagamento</button>
    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
    <input type="file" id="csvFile" accept=".csv" style="width: 100%; margin-bottom: 10px;">
    <button class="btn" onclick="iniciar()">2. Iniciar Fluxo Completo</button>
    
    <div id="log">Aguardando comando...</div>
</div>

<script>
    const API_KEY = "p4ePLADE4HmFnyySyvgLAwvQUgxJPSSqZoLbpveH";
    const PARTNER_KEY = "6a9ded89-ecaf-40fd-a844-56aa00c4c1ec";
    const logDiv = document.getElementById('log');
    let METODO_PAGAMENTO_ID = 103;

    function writeLog(msg, type = '') {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function consultarPagamentos() {
        writeLog("Consultando mÃ©todos ativos no seu painel...", "info");
        try {
            const res = await fetch("https://integracao.cardapioweb.com/api/partner/v1/merchant/payment_methods", {
                headers: { 'X-API-KEY': API_KEY, 'X-PARTNER-KEY': PARTNER_KEY }
            });
            const data = await res.json();
            data.forEach(m => {
                writeLog(`âœ… ID ${m.id}: ${m.name} identificado.`, "ok");
                METODO_PAGAMENTO_ID = m.id; 
            });
            writeLog("Sistema configurado com o Ãºltimo ID encontrado.", "info");
        } catch (e) {
            writeLog("Erro na consulta: " + e.message + ". Verifique se a extensÃ£o Allow CORS estÃ¡ LIGADA.", "err");
        }
    }

    async function iniciar() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Por favor, selecione o arquivo CSV primeiro.");
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                writeLog(`--- Iniciando lote de ${results.data.length} pedidos ---`, "info");
                for (let i = 0; i < results.data.length; i++) {
                    await processoPrincipal(results.data[i], i + 1);
                }
            }
        });
    }

    async function processoPrincipal(row, index) {
        const total = parseFloat(row.total) || 0;
        const nome = row.cliente_nome || "Cliente";
        const order_id = "IMP_" + Date.now() + "_" + index;

        // PASSO 1: CRIAÃ‡ÃƒO DO PEDIDO
        const payload = {
            "order_id": order_id,
            "display_id": (800 + index).toString(),
            "order_type": "takeout",
            "customer": {
                "name": nome,
                "phone": (row.cliente_telefone || "11999999999").replace(/\D/g, '').padEnd(11, '0').substring(0, 11)
            },
            "totals": { "order_amount": total, "delivery_fee": 0 },
            "items": [{ "name": row.produto_nome || "Item", "quantity": 1, "unit_price": total, "total_price": total }],
            "payments": [{ "total": total, "payment_method_id": METODO_PAGAMENTO_ID }]
        };

        try {
            writeLog(`-------------------------------------------`);
            writeLog(`ðŸ“¦ [${nome}] Passo 1: Criando pedido...`);
            
            const res = await fetch("https://integracao.cardapioweb.com/api/partner/v1/orders", {
                method: 'POST',
                headers: { 
                    'X-API-KEY': API_KEY, 
                    'X-PARTNER-KEY': PARTNER_KEY, 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (res.status === 201) {
                const data = await res.json();
                const apiId = data.id;
                writeLog(`âœ… Passo 1 OK: Criado com ID ${apiId}`, 'ok');

                // Pausas maiores para evitar erro de rede/conflito no servidor
                await new Promise(r => setTimeout(r, 2000));
                
                // PASSO 2, 3 e 4
                const sequencia = [
                    { status: "confirmed", label: "Passo 2: ACEITO" },
                    { status: "ready", label: "Passo 3: PRONTO" },
                    { status: "closed", label: "Passo 4: CONCLUÃDO" }
                ];

                for (const etapa of sequencia) {
                    const sucesso = await mudarStatusComRetry(apiId, etapa.status, etapa.label);
                    if (!sucesso) break; // Para o fluxo se um passo falhar
                    await new Promise(r => setTimeout(r, 1500));
                }

                writeLog(`ðŸ Ciclo completo para ${nome}`, "ok");
            } else {
                const errData = await res.json();
                writeLog(`âŒ Erro no Passo 1: ${JSON.stringify(errData.errors)}`, 'err');
            }
        } catch (e) {
            writeLog(`ðŸ’¥ Falha de conexÃ£o no Passo 1: ${e.message}`, 'err');
        }
    }

    async function mudarStatusComRetry(id, status, label) {
        const url = `https://integracao.cardapioweb.com/api/partner/v1/orders/${id}/status`;
        
        try {
            const res = await fetch(url, {
                method: 'PATCH',
                headers: { 
                    'X-API-KEY': API_KEY, 
                    'X-PARTNER-KEY': PARTNER_KEY, 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "status": status })
            });

            if (res.ok) {
                writeLog(`   â†³ ${label}`, 'step');
                return true;
            } else {
                const errorInfo = await res.text();
                writeLog(`   â†³ âš  Erro no ${status}: ${errorInfo}`, 'err');
                return false;
            }
        } catch (e) {
            writeLog(`   â†³ ðŸ”„ Erro de rede no ${status}. Tentativa de recuperaÃ§Ã£o...`, 'info');
            // Se der erro de rede, esperamos um pouco mais e tentamos UMA Ãºltima vez
            await new Promise(r => setTimeout(r, 2000));
            return await mudarStatusFinal(url, status, label);
        }
    }

    async function mudarStatusFinal(url, status, label) {
        try {
            const res = await fetch(url, {
                method: 'PATCH',
                headers: { 
                    'X-API-KEY': API_KEY, 'X-PARTNER-KEY': PARTNER_KEY, 'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "status": status })
            });
            if (res.ok) {
                writeLog(`   â†³ ${label} (Recuperado)`, 'step');
                return true;
            }
            return false;
        } catch (e) {
            writeLog(`   â†³ ðŸ’¥ Bloqueio persistente de rede no ${status}.`, 'err');
            return false;
        }
    }
</script>

</body>
</html>
